package com.data.component;

import java.lang.reflect.Field;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.base.component.AbstractComponent;
import com.base.database.annotation.ConfigPropertyAnnotation;
import com.data.bean.ConfigFloatBean;
import com.data.bean.ConfigStringBean;

/**
 * 系统参数组件
 */
public class GamePropertiesComponent extends AbstractComponent
{
    private static final Logger LOGGER = LoggerFactory.getLogger(GamePropertiesComponent.class.getName());

    @ConfigPropertyAnnotation(key = "MonitorJob", defaultValue = "*/5 * * * * ?", description = "每5秒调用一次系统监控", type = String.class)
    public static String MONITOR_JOB;

    @ConfigPropertyAnnotation(key = "job_ping_player", defaultValue = "5", description = "每5秒ping一次玩家", type = Integer.class)
    public static int JOB_PING_PLAYER;

    @ConfigPropertyAnnotation(key = "game_update_slow", defaultValue = "30000", description = "玩家都不在30秒后更新放缓", type = Integer.class)
    public static int GAME_UPDATE_SLOW;

    @ConfigPropertyAnnotation(key = "game_player_ping_interval", defaultValue = "5000", description = "游戏内玩家ping间隔 毫秒", type = Integer.class)
    public static int GAME_PLAYER_PING_INTERVAL;

    @ConfigPropertyAnnotation(key = "job_ping_fight", defaultValue = "5", description = "每5秒ping一次战斗服", type = Integer.class)
    public static int JOB_PING_FIGHT;

    @ConfigPropertyAnnotation(key = "job_save_player", defaultValue = "30", description = "定时器保存玩家时间间隔（秒）", type = Integer.class)
    public static int JOB_SAVE_PLAYER;

    @ConfigPropertyAnnotation(key = "save_player_time", defaultValue = "300", description = "每5分钟同步一次玩家信息（秒）", type = Integer.class)
    public static int SAVE_PLAYER_TIME;

    @ConfigPropertyAnnotation(key = "job_corn_refresh", defaultValue = "1 0 0 * * ? *", description = "每天凌晨刷新用户信息", type = String.class)
    public static String JOB_CORN_REFRESH;

    @ConfigPropertyAnnotation(key = "job_rank_refresh", defaultValue = "0 0 4 * * ? *", description = "每天凌晨刷新排行信息", type = String.class)
    public static String JOB_RANK_REFRESH;

    @ConfigPropertyAnnotation(key = "ping_max_time", defaultValue = "600", description = "ping延时最大时间(秒)", type = Integer.class)
    public static int PING_MAX_TIME;

    @ConfigPropertyAnnotation(key = "room_max_count", defaultValue = "3000", description = "起始房间最大个数", type = Integer.class)
    public static int ROOM_MAX_COUNT;

    @ConfigPropertyAnnotation(key = "max_level", description = "最高等级", type = Integer.class, defaultValue = "10")
    public static int MAX_LEVEL;

    @ConfigPropertyAnnotation(key = "sunday_refresh", defaultValue = "0 0 3 ? * 1", description = "周日凌晨刷新数据", type = String.class)
    public static String SUNDAY_REFRESH;
    
    
    @ConfigPropertyAnnotation(key = "world_event_refresh_time", defaultValue = "3600", description = "世界地图事件刷新间隔", type = Integer.class)
    public static int WORLD_EVENT_REFRESH_TIME;
    
    @ConfigPropertyAnnotation(key = "world_scene_add_count", defaultValue = "0.2", description = "世界地图场景增加率", type = Float.class)
    public static float WORLD_SCENE_ADD_COUNT;
    
    @ConfigPropertyAnnotation(key = "world_scene_update_time", defaultValue = "1000", description = "世界地图场景更新时间（毫秒）", type = Integer.class)
    public static int WORLD_SCENE_UPDATE_TIME;
    
    @ConfigPropertyAnnotation(key = "city_recycle_cdtime", defaultValue = "7200", description = "城市回收冷却时间（秒）", type = Integer.class)
    public static int CITY_RECYCLE_CDTIME;

    /**
     * 解析指定值到指定类型
     * 
     * @param fieldType
     *            字段类型
     * @param value
     *            以字符串表示的待转换值
     * @return 转换后的结果
     */
    private Object parseValue(Class<?> fieldType, String value)
    {
        Object fieldValue = null;
        value = value.trim();

        try
        {
            if (fieldType == Integer.class)
            {
                fieldValue = (int) Float.parseFloat(value);
            }
            else if (fieldType == Boolean.class)
            {
                fieldValue = Boolean.parseBoolean(value);
            }
            else if (fieldType == Date.class)
            {
                fieldValue = new SimpleDateFormat("yyyy/MM/dd HH:mm:ss").parse(value);
            }
            else if (fieldType == Double.class)
            {
                fieldValue = Double.parseDouble(value);
            }
            else if (fieldType == Float.class)
            {
                fieldValue = Float.parseFloat(value);
            }
            else
            {
                fieldValue = value;
            }
            return fieldValue;
        }
        catch (Exception e)
        {
            LOGGER.error("Exception : ServerProperties Load: ", e);
            return null;
        }
    }

    @Override
    public boolean initialize()
    {
        try
        {
            Field[] allFields = GamePropertiesComponent.class.getFields();

            // 字符串配置、float配置
            List<ConfigFloatBean> floatList = SystemDataComponent.getBeanList(ConfigFloatBean.class);
            List<ConfigStringBean> stringList = SystemDataComponent.getBeanList(ConfigStringBean.class);

            Map<String, String> temp = new HashMap<>();
            floatList.forEach(p -> temp.put(p.getKeyID(), String.valueOf(p.getValue())));
            stringList.forEach(p -> temp.put(p.getKeyID(), p.getValue()));

            for (Field field : allFields)
            {
                ConfigPropertyAnnotation annotation = field.getAnnotation(ConfigPropertyAnnotation.class);

                if (annotation != null)
                {
                    String valueString = annotation.defaultValue();

                    boolean find = false;

                    for (Entry<String, String> bean : temp.entrySet())
                    {
                        if (bean.getKey().equalsIgnoreCase(annotation.key()))
                        {
                            valueString = bean.getValue();
                            find = true;
                            break;
                        }
                    }

                    if (!find)
                        LOGGER.error("Cannot find server property keep it default value.  -- " + annotation.key()
                                + " = " + valueString);

                    try
                    {
                        field.set(null, parseValue(annotation.type(), valueString));
                    }
                    catch (Exception e)
                    {
                        LOGGER.error(annotation.key() + " " + field.getName() + "fail to load GamePropertiesComponent",
                                e);
                        return false;
                    }
                }
            }
        }
        catch (Exception e)
        {
            LOGGER.error("加载配置出错", e);
            return false;
        }

        return true;
    }

    @Override
    public void stop()
    {

    }

}
