package com.game.module;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

import com.base.code.ErrorCodeType;
import com.data.bean.ChargeBean;
import com.data.bean.factory.ChargeBeanFactory;
import com.data.business.PlayerBusiness;
import com.data.info.ChargeInfo;
import com.data.info.FriendInfo;
import com.data.info.RankInfo;
import com.game.component.GamePlayerComponent;
import com.game.component.RankComponent;
import com.game.object.player.GamePlayer;
import com.logic.object.module.AbstractPlayerModule;
import com.proto.command.UserCmdType.UserCmdOutType;
import com.proto.common.gen.CommonOutMsg.RankTimeType;
import com.proto.common.gen.CommonOutMsg.RankType;
import com.proto.user.gen.UserOutMsg.RechargeProtoOut;
import com.util.TimeUtil;
import com.util.UuidUtil;

/**
 * 玩家数据模块
 * 
 * @author dream
 *
 */
public class PlayerDataModule extends AbstractPlayerModule<GamePlayer>
{
    /** 玩家的排行信息<时间类型-排行类型,数据> */
    private Map<String, RankInfo> rankInfoMap = new ConcurrentHashMap<String, RankInfo>();

    private Map<Integer, FriendInfo> friendMap = new ConcurrentHashMap<>();

    private Map<String, ChargeInfo> chargeInfoMap = new ConcurrentHashMap<>();

    public PlayerDataModule(GamePlayer player)
    {
        super(player);
    }

    public boolean load()
    {
        List<RankInfo> list = PlayerBusiness.queryPlayerRank(player.getUserID());
        list.forEach(p -> {
            rankInfoMap.put(p.getTimeType() + "-" + p.getRankType(), p);
        });

        return true;
    }

    public boolean relogin()
    {
        // 不是同一天登录,刷新
        if (!TimeUtil.isSameDay(new Date(), player.getPlayerInfo().getLastLoginTime()))
            refresh(false);

        return true;
    }

    public void refresh(boolean isSend)
    {
        player.getPlayerInfo().setIsCanUnlockCoinModeByAD(false);
        player.getPlayerInfo().setLastAdTime(null);
        player.getPlayerInfo().setAdTriggerCount(0);
        if (isSend)
            player.getSenderModule().sendRes();
    }

    /**
     * 周,月刷新排行数据
     * 
     * @param timeType
     */
    public void refreshRank(RankTimeType timeType)
    {
        RankType[] rankTypes = RankType.values();
        for (RankType rankType : rankTypes)
        {
            RankInfo info = rankInfoMap.get(timeType.getNumber() + "-" + rankType.getNumber());
            if (info != null)
            {
                info.setRankValue(0);
            }
        }

        save();
    }

    public void send()
    {

    }

    public boolean save()
    {
        List<RankInfo> list = new ArrayList<RankInfo>();
        list.addAll(rankInfoMap.values());

        for (RankInfo info : list)
        {
            if (info.isChanged())
                PlayerBusiness.addOrUpdateRank(info);
        }

        List<ChargeInfo> list2 = new ArrayList<>();
        if (!chargeInfoMap.isEmpty())
            list2.addAll(chargeInfoMap.values());

        for (ChargeInfo info : list2)
        {
            if (info.isChanged())
                PlayerBusiness.addOrUpdateCharge(info);
        }

        return true;
    }

    public void addRank(RankType type, int value)
    {
        if (value <= 0)
            return;

        RankTimeType[] types = RankTimeType.values();
        for (RankTimeType timeType : types)
        {
            RankInfo info = rankInfoMap.get(timeType.getNumber() + "-" + type.getNumber());
            if (info == null)
            {
                info = new RankInfo();
                info.setUserID(player.getUserID());
                info.setRankType(type.getNumber());

                if (type == RankType.GoodPersion || type == RankType.Net)
                {
                    info.setRankValue(value + info.getRankValue());
                }
                else
                    info.setRankValue(value);

                info.setHeader(player.getPlayerInfo().getHeaderID());
                info.setNickName(player.getNickName());
                info.setTimeType(timeType.getNumber());
                info.setUpdateTime(new Date());

                rankInfoMap.put(timeType.getNumber() + "-" + type.getNumber(), info);

                RankComponent.addRank(info);
            }
            else
            {
                if (info.getRankType() == RankType.RACE_VALUE)
                {
                    if (value < info.getRankValue() || info.getRankValue() > 0)
                    {
                        info.setRankValue(value);
                        info.setHeader(player.getPlayerInfo().getHeaderID());
                        info.setNickName(player.getNickName());

                        RankComponent.addRank(info);
                    }
                }
                else if (info.getRankType() == RankType.GoodPersion_VALUE || info.getRankType() == RankType.Net_VALUE)
                {
                    info.setRankValue(value + info.getRankValue());
                    info.setHeader(player.getPlayerInfo().getHeaderID());
                    info.setNickName(player.getNickName());

                    RankComponent.addRank(info);
                }
                else
                {
                    if (value > info.getRankValue())
                    {
                        info.setRankValue(value);
                        info.setHeader(player.getPlayerInfo().getHeaderID());
                        info.setNickName(player.getNickName());

                        RankComponent.addRank(info);
                    }
                }
            }
        }
    }

    public Map<Integer, FriendInfo> getAllFriends()
    {
        return friendMap;
    }

    public void changeHeader(int header)
    {
        List<RankInfo> list = new ArrayList<RankInfo>();
        list.addAll(rankInfoMap.values());

        for (RankInfo info : list)
        {
            info.setHeader(header);
        }
    }

    public void charge(int configID)
    {
        ChargeBean bean = ChargeBeanFactory.getChargeBean(configID);
        if (bean == null)
        {
            player.sendErrorCode(ErrorCodeType.Config_Error, "配置错误.");
            return;
        }

        String sku = bean.getGoogleSKU();
        String orderID = UuidUtil.generateGUID();

        ChargeInfo chargeInfo = new ChargeInfo();
        chargeInfo.setAccountName(player.getPlayerInfo().getAccountName());
        chargeInfo.setConfigID(configID);
        chargeInfo.setCreateTime(new Date());
        chargeInfo.setOrderId(orderID);
        chargeInfo.setOrderStatus(1);
        chargeInfo.setPayMoney(bean.getChargeValue());
        chargeInfo.setPayTime(new Date());
        chargeInfo.setUserID(player.getUserID());
        chargeInfo.setPayWay("google");

        chargeInfoMap.put(orderID, chargeInfo);

        RechargeProtoOut.Builder builder = RechargeProtoOut.newBuilder();
        builder.setOrderNum(orderID);
        builder.setProductID(sku);
        player.sendMessage(UserCmdOutType.RECHARGE_RESULT_VALUE, builder);
    }

    public void chargeCheck(String orderID, String purchaseToken)
    {
        ChargeInfo chargeInfo = chargeInfoMap.get(orderID);
        if (chargeInfo == null)
        {
            chargeInfo = PlayerBusiness.getChargeInfo(player.getUserID(), orderID);
        }

        if (chargeInfo == null)
        {
            player.sendErrorCode(ErrorCodeType.Charge_Order, "");
            return;
        }

        GamePlayerComponent.checkPay(chargeInfo.getConfigID(), purchaseToken);
    }
}
